#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
flake_target="${repo_root}#Pro"

usage() {
  cat <<'EOF'
Usage: ./scripts/darwin-pro <build|switch|rollback|edit>
EOF
}

cmd="${1:-}"
case "$cmd" in
  build)
    shift
    exec env -u DEVELOPER_DIR -u SDKROOT \
      nix --extra-experimental-features "nix-command flakes" \
      run nix-darwin -- build --flake "$flake_target" "$@"
    ;;
  switch)
    shift
    exec env -u DEVELOPER_DIR -u SDKROOT \
      sudo nix --extra-experimental-features "nix-command flakes" \
      run nix-darwin -- switch --flake "$flake_target" "$@"
    ;;
  rollback)
    shift
    # Rollback is generation-based; flake selection does not apply.
    exec env -u DEVELOPER_DIR -u SDKROOT \
      sudo nix --extra-experimental-features "nix-command flakes" \
      run nix-darwin -- switch --rollback "$@"
    ;;
  edit)
    shift
    exec "${EDITOR:-vi}" \
      "$@" \
      "${repo_root}/flake.nix" \
      "${repo_root}/hosts/darwin/Pro/default.nix"
    ;;
  *)
    usage >&2
    exit 1
    ;;
esac
